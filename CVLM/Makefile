# Makefile pour CVLM - Commandes simplifi√©es
.PHONY: help build up down restart logs shell db-shell test clean init migrate

# Couleurs pour les messages
BLUE=\033[0;34m
GREEN=\033[0;32m
RED=\033[0;31m
NC=\033[0m # No Color

help: ## Affiche cette aide
	@echo "$(BLUE)CVLM - Commandes disponibles :$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

# ===== DOCKER =====

build: ## Build les images Docker
	@echo "$(BLUE)üî® Build des images Docker...$(NC)"
	docker compose build

up: ## D√©marre tous les services
	@echo "$(BLUE)üöÄ D√©marrage des services...$(NC)"
	docker compose up -d
	@echo "$(GREEN)‚úÖ Services d√©marr√©s !$(NC)"
	@echo "$(BLUE)API:$(NC) http://localhost:8000"
	@echo "$(BLUE)Streamlit:$(NC) http://localhost:8501"
	@echo "$(BLUE)Docs:$(NC) http://localhost:8000/docs"

up-dev: ## D√©marre avec PgAdmin (mode d√©veloppement)
	@echo "$(BLUE)üöÄ D√©marrage mode d√©veloppement...$(NC)"
	docker compose --profile dev up -d
	@echo "$(GREEN)‚úÖ Services d√©marr√©s !$(NC)"
	@echo "$(BLUE)API:$(NC) http://localhost:8000"
	@echo "$(BLUE)Streamlit:$(NC) http://localhost:8501"
	@echo "$(BLUE)PgAdmin:$(NC) http://localhost:5050"

down: ## Arr√™te tous les services
	@echo "$(BLUE)‚èπÔ∏è  Arr√™t des services...$(NC)"
	docker compose down

restart: ## Red√©marre tous les services
	@echo "$(BLUE)üîÑ Red√©marrage des services...$(NC)"
	docker compose restart

rebuild: ## Rebuild et red√©marre tous les services
	@echo "$(BLUE)üî® Rebuild complet...$(NC)"
	docker compose down
	docker compose up -d --build
	@echo "$(GREEN)‚úÖ Services red√©marr√©s !$(NC)"

logs: ## Affiche les logs en temps r√©el
	docker compose logs -f

logs-api: ## Logs de l'API uniquement
	docker compose logs -f api

logs-db: ## Logs de PostgreSQL uniquement
	docker compose logs -f postgres

status: ## Affiche le statut des services
	@echo "$(BLUE)üìä Statut des services :$(NC)"
	docker compose ps

# ===== ACC√àS AUX CONTENEURS =====

shell: ## Shell dans le conteneur API
	docker compose exec api bash

shell-db: ## Shell dans PostgreSQL
	docker compose exec postgres psql -U cvlm_user -d cvlm_db

# ===== BASE DE DONN√âES =====

init: ## Initialise la base de donn√©es
	@echo "$(BLUE)üîß Initialisation de la base de donn√©es...$(NC)"
	docker compose exec api python init_database.py
	@echo "$(GREEN)‚úÖ Base initialis√©e !$(NC)"

init-reset: ## R√©initialise la base (‚ö†Ô∏è supprime les donn√©es)
	@echo "$(RED)‚ö†Ô∏è  ATTENTION : Cela va supprimer toutes les donn√©es !$(NC)"
	@read -p "Continuer ? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker compose exec api python init_database.py --reset; \
		echo "$(GREEN)‚úÖ Base r√©initialis√©e !$(NC)"; \
	fi

migrate: ## Migre les donn√©es existantes vers la DB
	@echo "$(BLUE)üîÑ Migration des donn√©es...$(NC)"
	docker compose exec api python migrate_data.py

backup: ## Backup de la base de donn√©es
	@echo "$(BLUE)üíæ Backup de la base...$(NC)"
	docker compose exec postgres pg_dump -U cvlm_user cvlm_db > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)‚úÖ Backup cr√©√© !$(NC)"

restore: ## Restaure la base depuis backup.sql
	@if [ ! -f backup.sql ]; then \
		echo "$(RED)‚ùå Fichier backup.sql introuvable$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)üì• Restauration de la base...$(NC)"
	docker compose exec -T postgres psql -U cvlm_user cvlm_db < backup.sql
	@echo "$(GREEN)‚úÖ Base restaur√©e !$(NC)"

# ===== D√âVELOPPEMENT =====

install: ## Installe les d√©pendances localement (pour IDE)
	pip install -r requirements.txt

install-dev: ## Installe les d√©pendances de d√©veloppement
	pip install -r requirements.txt
	pip install -r requirements-dev.txt

test: ## Lance les tests
	@echo "$(BLUE)üß™ Ex√©cution des tests...$(NC)"
	docker compose exec api pytest tests/ -v

test-local: ## Lance les tests localement
	pytest tests/ -v

lint: ## V√©rifie le code avec flake8
	@echo "$(BLUE)üîç V√©rification du code...$(NC)"
	docker compose exec api flake8 domain/ infrastructure/ --max-line-length=120

format: ## Formate le code avec black
	@echo "$(BLUE)‚ú® Formatage du code...$(NC)"
	docker compose exec api black domain/ infrastructure/

# ===== NETTOYAGE =====

clean: ## Nettoie les conteneurs, volumes et images
	@echo "$(RED)‚ö†Ô∏è  Nettoyage complet...$(NC)"
	docker compose down -v
	docker system prune -f
	@echo "$(GREEN)‚úÖ Nettoyage termin√© !$(NC)"

clean-data: ## Supprime les donn√©es persist√©es (‚ö†Ô∏è perte de donn√©es)
	@echo "$(RED)‚ö†Ô∏è  ATTENTION : Suppression des donn√©es !$(NC)"
	@read -p "Continuer ? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		rm -rf data/files/*; \
		docker volume rm cvlm_postgres_data 2>/dev/null || true; \
		echo "$(GREEN)‚úÖ Donn√©es supprim√©es !$(NC)"; \
	fi

clean-logs: ## Supprime les logs
	@echo "$(BLUE)üßπ Suppression des logs...$(NC)"
	rm -rf logs/*.log
	@echo "$(GREEN)‚úÖ Logs supprim√©s !$(NC)"

# ===== PRODUCTION =====

prod-build: ## Build pour la production
	@echo "$(BLUE)üè≠ Build production...$(NC)"
	docker compose -f docker-compose.yml -f docker-compose.prod.yml build

prod-up: ## D√©marre en mode production
	@echo "$(BLUE)üöÄ D√©marrage production...$(NC)"
	docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
	@echo "$(GREEN)‚úÖ Production d√©marr√©e !$(NC)"

prod-down: ## Arr√™te la production
	docker compose -f docker-compose.yml -f docker-compose.prod.yml down

# ===== UTILITAIRES =====

check-env: ## V√©rifie que le fichier .env existe
	@if [ ! -f .env ]; then \
		echo "$(RED)‚ùå Fichier .env introuvable$(NC)"; \
		echo "$(BLUE)Copier .env.example vers .env et le configurer$(NC)"; \
		exit 1; \
	else \
		echo "$(GREEN)‚úÖ Fichier .env trouv√©$(NC)"; \
	fi

health: ## V√©rifie la sant√© des services
	@echo "$(BLUE)üè• V√©rification de la sant√©...$(NC)"
	@curl -s http://localhost:8000/health | jq . || echo "$(RED)API non accessible$(NC)"

watch-logs: ## Logs avec filtrage des erreurs
	docker compose logs -f | grep -i --color=always -E "error|warning|exception|$$"

stats: ## Statistiques des conteneurs
	docker stats --no-stream

# ===== D√âVELOPPEMENT LOCAL (sans Docker) =====

local-db: ## D√©marre uniquement PostgreSQL (pour dev local)
	docker compose up -d postgres
	@echo "$(GREEN)‚úÖ PostgreSQL d√©marr√© sur localhost:5432$(NC)"

local-api: ## Lance l'API localement
	uvicorn api_server:app --reload

local-streamlit: ## Lance Streamlit localement
	streamlit run streamlit_app.py

local-stop: ## Arr√™te les services Docker
	docker compose down

.DEFAULT_GOAL := help
